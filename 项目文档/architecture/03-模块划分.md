# Bubbles-CN 模块划分

## 概述

Bubbles-CN 项目采用模块化设计，将功能划分为多个独立的组件模块。每个模块负责特定的 UI 功能，可以独立使用或与其他模块组合使用。本文档详细说明了项目的模块划分、各模块的职责以及模块间的交互关系。

## 模块分类

### 按功能分类

```
Bubbles-CN
│
├── 基础模块
│   ├── key          - 键绑定管理
│   ├── cursor       - 光标管理
│   └── runeutil     - 字符工具函数
│
├── 输入模块
│   ├── textinput    - 单行文本输入
│   └── textarea     - 多行文本输入
│
├── 显示模块
│   ├── spinner      - 加载指示器
│   ├── progress     - 进度条
│   ├── table        - 表格显示
│   ├── list         - 列表显示
│   └── help         - 帮助信息
│
├── 导航模块
│   ├── viewport     - 滚动视口
│   ├── paginator    - 分页器
│   └── filepicker   - 文件选择器
│
└── 时间模块
    ├── timer        - 倒计时器
    └── stopwatch    - 秒表
```

### 按层次分类

```
┌─────────────────────────────────────────────────────────┐
│                    应用层 (Application)                     │
│              使用 Bubbles-CN 组件的业务应用                 │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    组件层 (Components)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 输入模块  │  │ 显示模块  │  │ 导航模块  │  │ 时间模块  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    基础层 (Foundation)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                │
│  │   Key    │  │  Cursor  │  │ Runeutil │                │
│  └──────────┘  └──────────┘  └──────────┘                │
└─────────────────────────────────────────────────────────┘
```

## 模块详细说明

### 1. 基础模块

#### 1.1 Key 模块

**目录**: `key/`

**职责**:
- 管理键盘快捷键绑定
- 提供键匹配功能
- 生成帮助信息

**核心功能**:
```go
type Binding struct {
    keys      []string
    help      string
    enabled   bool
    disabled  bool
}

// 主要方法
func NewBinding(opts ...Option) Binding
func (b Binding) WithKeys(keys ...string) Binding
func (b Binding) WithHelp(key, desc string) Binding
func Matches(msg tea.KeyMsg, bindings ...Binding) bool
```

**使用场景**:
- 统一管理应用程序的键盘快捷键
- 自动生成帮助菜单
- 处理键盘事件

**依赖关系**:
- 依赖: Bubble Tea

**示例**:
```go
var keyMap = struct {
    Up    key.Binding
    Down  key.Binding
    Enter key.Binding
}{
    Up:    key.NewBinding(key.WithKeys("k", "up")),
    Down:  key.NewBinding(key.WithKeys("j", "down")),
    Enter: key.NewBinding(key.WithKeys("enter")),
}
```

#### 1.2 Cursor 模块

**目录**: `cursor/`

**职责**:
- 管理光标状态
- 控制光标闪烁
- 处理光标位置

**核心功能**:
```go
type Model struct {
    Hidden     bool
    BlinkSpeed time.Duration
    Character  string
}

// 主要方法
func New() Model
func (m Model) Blink() bool
func (m Model) View() string
```

**使用场景**:
- 文本输入组件的光标管理
- 表单字段的光标控制
- 需要光标显示的任何场景

**依赖关系**:
- 依赖: 无（独立模块）

**示例**:
```go
cursor := cursor.New()
cursor.BlinkSpeed = 500 * time.Millisecond
cursorView := cursor.View()
```

#### 1.3 Runeutil 模块

**目录**: `runeutil/`

**职责**:
- 提供字符处理工具函数
- 处理多字节字符
- 字符宽度计算

**核心功能**:
```go
// 主要函数
func NewRuneClusterReader(r io.Reader) io.Reader
func RuneWidth(r rune) int
func StringWidth(s string) int
func Truncate(s string, maxWidth int) string
```

**使用场景**:
- 文本截断和换行
- 多字节字符处理
- 字符宽度计算

**依赖关系**:
- 依赖: 无（工具函数库）

**示例**:
```go
width := runeutil.StringWidth("你好世界")
truncated := runeutil.Truncate("这是一个很长的文本", 10)
```

### 2. 输入模块

#### 2.1 TextInput 模块

**目录**: `textinput/`

**职责**:
- 提供单行文本输入功能
- 处理键盘输入和编辑
- 支持粘贴和验证

**核心功能**:
```go
type Model struct {
    Err          error
    Prompt       string
    Placeholder  string
    EchoMode     EchoMode
    EchoCharacter rune
    Value        string
    Cursor       cursor.Model
    Width        int
    CharLimit    int
}

// 主要方法
func New() Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) Focus() Model
func (m Model) Blur() Model
func (m Model) SetValue(s string) Model
func (m Model) CursorStart() Model
func (m Model) CursorEnd() Model
```

**使用场景**:
- 用户名输入
- 密码输入
- 搜索框
- 命令输入

**依赖关系**:
- 依赖: cursor, key, clipboard

**示例**:
```go
textInput := textinput.New()
textInput.Placeholder = "请输入用户名"
textInput.Focus()
```

#### 2.2 TextArea 模块

**目录**: `textarea/`

**职责**:
- 提供多行文本输入功能
- 支持垂直滚动
- 处理大文本编辑

**核心功能**:
```go
type Model struct {
    Value        string
    Prompt       string
    Placeholder  string
    Cursor       cursor.Model
    Width        int
    Height       int
    CharLimit    int
    ShowLineNumbers bool
}

// 主要方法
func New() Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) Focus() Model
func (m Model) Blur() Model
func (m Model) SetValue(s string) Model
func (m Model) SetWidth(w int) Model
func (m Model) SetHeight(h int) Model
```

**使用场景**:
- 聊天输入框
- 代码编辑器
- 备注输入
- 长文本编辑

**依赖关系**:
- 依赖: cursor, key, viewport

**示例**:
```go
textarea := textarea.New()
textarea.Placeholder = "请输入消息..."
textarea.SetHeight(10)
```

### 3. 显示模块

#### 3.1 Spinner 模块

**目录**: `spinner/`

**职责**:
- 显示加载动画
- 提供多种样式
- 支持自定义帧

**核心功能**:
```go
type Model struct {
    Type  SpinnerType
    Style lipgloss.Style
}

type SpinnerType int

const (
    Line SpinnerType = iota
    Dot
    MiniDot
    Jump
    Points
    Globe
    Moon
    Monkey
    Meter
    Hamburger
    Ellipsis
)

// 主要方法
func New() Model
func (m Model) View() string
func (m Model) Tick() tea.Cmd
```

**使用场景**:
- 加载状态指示
- 后台任务处理
- 网络请求等待

**依赖关系**:
- 依赖: 无（独立模块）

**示例**:
```go
spinner := spinner.New()
spinner.Type = spinner.Dot
spinnerView := spinner.View()
```

#### 3.2 Progress 模块

**目录**: `progress/`

**职责**:
- 显示进度条
- 支持纯色和渐变
- 可选动画效果

**核心功能**:
```go
type Model struct {
    Percent      float64
    Width        int
    Full         *lipgloss.Style
    Empty        *lipgloss.Style
    Head         *lipgloss.Style
    ShowPercentage bool
}

// 主要方法
func New(opts ...Option) Model
func (m Model) View() string
func (m Model) SetPercent(p float64) Model
func (m Model) IncrPercent(delta float64) Model
func (m Model) PercentAsFloat() float64
func (m Model) WidthAsInt() int
```

**使用场景**:
- 文件下载进度
- 任务处理进度
- 批量操作进度

**依赖关系**:
- 依赖: lipgloss, harmonica（动画）

**示例**:
```go
progress := progress.New(
    progress.WithDefaultGradient(),
    progress.WithWidth(40),
    progress.WithoutPercentage(),
)
progress.SetPercent(0.5)
```

#### 3.3 Table 模块

**目录**: `table/`

**职责**:
- 显示表格数据
- 支持滚动和导航
- 可自定义样式

**核心功能**:
```go
type Model struct {
    KeyMap KeyMap
    Help   help.Model
    cols   []Column
    rows   []Row
    cursor int
    focus  bool
    styles Styles
}

type Column struct {
    Title string
    Width int
}

type Row []string

// 主要方法
func New(cols []Column) Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) SetRows(rows []Row) Model
func (m Model) SetCursor(i int) Model
func (m Model) SetWidth(i int) Model
func (m Model) SetHeight(i int) Model
```

**使用场景**:
- 数据列表显示
- 文件列表
- 配置项显示

**依赖关系**:
- 依赖: key, help, viewport, lipgloss

**示例**:
```go
columns := []table.Column{
    {Title: "名称", Width: 20},
    {Title: "大小", Width: 10},
    {Title: "修改时间", Width: 20},
}
t := table.New(columns)
t.SetRows(rows)
```

#### 3.4 List 模块

**目录**: `list/`

**职责**:
- 显示项目列表
- 支持过滤和分页
- 可自定义项目渲染

**核心功能**:
```go
type Model struct {
    KeyMap       key.KeyMap
    Title        string
    Items        []Item
    Cursor       int
    SelectedItem Item
    FilterState  FilterState
    Paginator    paginator.Model
    ShowHelp     bool
}

type Item interface {
    FilterValue() string
}

// 主要方法
func New(opts ...Option) Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) SetItems(i []Item) Model
func (m Model) SetDelegate(d ItemDelegate) Model
func (m Model) SetShowHelp(b bool) Model
func (m Model) SetShowPagination(b bool) Model
func (m Model) SetShowStatusBar(b bool) Model
func (m Model) SetFilteringEnabled(b bool) Model
```

**使用场景**:
- 菜单选择
- 文件浏览
- 项目列表

**依赖关系**:
- 依赖: key, help, paginator, spinner, textinput, lipgloss

**示例**:
```go
items := list.NewDefaultItems()
l := list.New(items)
l.Title = "选择项目"
l.SetShowHelp(true)
```

#### 3.5 Help 模块

**目录**: `help/`

**职责**:
- 显示帮助信息
- 自动生成帮助菜单
- 支持单行和多行模式

**核心功能**:
```go
type Model struct {
    ShowAll      bool
    ShortSeparator string
    FullSeparator string
    Keys          []KeyBinding
}

// 主要方法
func New() Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) Show(b bool) Model
func (m Model) Full() Model
func (m Model) Short() Model
```

**使用场景**:
- 显示快捷键帮助
- 显示操作提示
- 用户引导

**依赖关系**:
- 依赖: key

**示例**:
```go
help := help.New()
help.ShowAll = true
helpView := help.View()
```

### 4. 导航模块

#### 4.1 Viewport 模块

**目录**: `viewport/`

**职责**:
- 提供滚动视口
- 支持垂直滚动
- 可选分页键绑定

**核心功能**:
```go
type Model struct {
    KeyMap  KeyMap
    YOffset int
    YPosition int
    Height  int
    Width   int
    HighPerformanceViewport bool
}

// 主要方法
func New(width, height int) Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) SetContent(s string) Model
func (m Model) SetYOffset(n int) Model
func (m Model) GotoTop() Model
func (m Model) GotoBottom() Model
func (m Model) LineDown(n int) Model
func (m Model) LineUp(n int) Model
```

**使用场景**:
- 长文本显示
- 日志查看
- 文档浏览

**依赖关系**:
- 依赖: key, lipgloss

**示例**:
```go
viewport := viewport.New(80, 20)
viewport.SetContent(longText)
viewport.GotoTop()
```

#### 4.2 Paginator 模块

**目录**: `paginator/`

**职责**:
- 管理分页逻辑
- 可选绘制分页 UI
- 支持多种分页样式

**核心功能**:
```go
type Model struct {
    Type          Type
    PerPage       int
    TotalPages    int
    Page          int
    ActiveDot     lipgloss.Style
    InactiveDot   lipgloss.Style
}

type Type int

const (
    Dots Type = iota
    Arabic
)

// 主要方法
func New() Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) ItemsOnPage(totalItems int) (start, end int)
func (m Model) SetTotalPages(n int) Model
func (m Model) SetPage(n int) Model
func (m Model) NextPage() Model
func (m Model) PrevPage() Model
func (m Model) PageOnBottom() Model
func (m Model) PageOnTop() Model
```

**使用场景**:
- 列表分页
- 数据分页
- 内容分页

**依赖关系**:
- 依赖: key, lipgloss

**示例**:
```go
paginator := paginator.New()
paginator.PerPage = 10
paginator.SetTotalPages(5)
```

#### 4.3 FilePicker 模块

**目录**: `filepicker/`

**职责**:
- 文件系统浏览
- 文件选择
- 支持过滤和排序

**核心功能**:
```go
type Model struct {
    CurrentDirectory string
    SelectedFiles    []string
    ShowPermissions  bool
    ShowSize         bool
    ShowHidden       bool
    AutoHeight       bool
    Cursor           cursor.Model
    FileAllowed      FileFilter
    DirAllowed       FileFilter
}

type FileFilter func(os.FileInfo) bool

// 主要方法
func New() Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) SetCurrentDirectory(path string) (Model, error)
func (m Model) SelectedFile() string
func (m Model) SelectedFiles() []string
```

**使用场景**:
- 文件选择对话框
- 目录浏览
- 文件打开/保存

**依赖关系**:
- 依赖: cursor, key, list, lipgloss

**示例**:
```go
filepicker := filepicker.New()
filepicker.CurrentDirectory, _ = os.Getwd()
filepicker.ShowHidden = false
```

### 5. 时间模块

#### 5.1 Timer 模块

**目录**: `timer/`

**职责**:
- 倒计时功能
- 可自定义更新频率
- 可自定义输出格式

**核心功能**:
```go
type Model struct {
    Timeout      time.Duration
    Interval     time.Duration
    StartTime    time.Time
    Style        lipgloss.Style
}

// 主要方法
func New(opts ...Option) Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) Init() tea.Cmd
func (m Model) Start() Model
func (m Model) Stop() Model
func (m Model) Reset() Model
func (m Model) Toggle() (Model, tea.Cmd)
```

**使用场景**:
- 倒计时器
- 定时提醒
- 时间限制

**依赖关系**:
- 依赖: lipgloss

**示例**:
```go
timer := timer.New(
    timer.WithInterval(time.Second),
    timer.WithTimeout(5*time.Minute),
)
timer.Start()
```

#### 5.2 Stopwatch 模块

**目录**: `stopwatch/`

**职责**:
- 计时功能
- 可自定义更新频率
- 可自定义输出格式

**核心功能**:
```go
type Model struct {
    Interval     time.Duration
    Elapsed      time.Duration
    StartTime    time.Time
    Style        lipgloss.Style
}

// 主要方法
func New(opts ...Option) Model
func (m Model) Update(msg tea.Msg) (Model, tea.Cmd)
func (m Model) View() string
func (m Model) Init() tea.Cmd
func (m Model) Start() Model
func (m Model) Stop() Model
func (m Model) Reset() Model
func (m Model) Toggle() (Model, tea.Cmd)
```

**使用场景**:
- 秒表
- 计时器
- 性能测量

**依赖关系**:
- 依赖: lipgloss

**示例**:
```go
stopwatch := stopwatch.New(
    stopwatch.WithInterval(time.Millisecond),
)
stopwatch.Start()
```

## 模块依赖关系

### 依赖关系图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        组件层                                 │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │ TextInput│  │ TextArea │  │   List   │  │  Table   │     │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │
│       │              │              │              │          │
│       │              │              │              │          │
│       ▼              ▼              ▼              ▼          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │  Cursor  │  │ Viewport │  │Paginator │  │   Help   │     │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │
│       │              │              │              │          │
│       │              │              │              │          │
│       ▼              ▼              ▼              ▼          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │   Key    │  │   Key    │  │   Key    │  │   Key    │     │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        基础层                                 │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │   Key    │  │  Cursor  │  │ Runeutil │  │  Bubble  │     │
│  │          │  │          │  │          │  │   Tea    │     │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 模块间依赖表

| 模块 | 依赖模块 | 说明 |
|------|---------|------|
| **TextInput** | cursor, key, clipboard | 光标、键绑定、剪贴板 |
| **TextArea** | cursor, key, viewport | 光标、键绑定、视口 |
| **List** | key, help, paginator, spinner, textinput | 键绑定、帮助、分页、加载、输入 |
| **Table** | key, help, viewport | 键绑定、帮助、视口 |
| **Viewport** | key | 键绑定 |
| **Paginator** | key | 键绑定 |
| **FilePicker** | cursor, key, list | 光标、键绑定、列表 |
| **Help** | key | 键绑定 |
| **Timer** | 无 | 独立模块 |
| **Stopwatch** | 无 | 独立模块 |
| **Spinner** | 无 | 独立模块 |
| **Progress** | 无 | 独立模块 |
| **Key** | 无 | 基础模块 |
| **Cursor** | 无 | 基础模块 |
| **Runeutil** | 无 | 工具模块 |

## 模块接口规范

### 组件接口

所有组件都应实现 Bubble Tea 的标准接口：

```go
type Model interface {
    Init() tea.Cmd
    Update(msg tea.Msg) (Model, tea.Cmd)
    View() string
}
```

### 键绑定接口

如果组件需要显示帮助，应实现以下接口：

```go
type KeyMap interface {
    ShortHelp() []key.Binding
    FullHelp() [][]key.Binding
}
```

### 项目委托接口（List 组件）

```go
type ItemDelegate interface {
    Render(w io.Writer, m Model, index int, item Item)
    Height() int
    Spacing() int
    Update(msg tea.Msg, m *Model) tea.Cmd
}
```

## 模块组合示例

### 示例 1: 简单表单

```go
type FormModel struct {
    username textinput.Model
    password textinput.Model
    submit   bool
}

func NewFormModel() FormModel {
    username := textinput.New()
    username.Placeholder = "用户名"
    
    password := textinput.New()
    password.Placeholder = "密码"
    password.EchoMode = textinput.EchoPassword
    
    return FormModel{
        username: username,
        password: password,
    }
}

func (m FormModel) View() string {
    return lipgloss.JoinVertical(
        lipgloss.Left,
        "用户名: "+m.username.View(),
        "密码: "+m.password.View(),
    )
}
```

### 示例 2: 文件浏览器

```go
type FileBrowserModel struct {
    filepicker filepicker.Model
    viewport   viewport.Model
    help       help.Model
}

func NewFileBrowserModel() FileBrowserModel {
    fp := filepicker.New()
    fp.CurrentDirectory, _ = os.Getwd()
    
    vp := viewport.New(80, 20)
    
    return FileBrowserModel{
        filepicker: fp,
        viewport:   vp,
        help:       help.New(),
    }
}
```

## 模块扩展指南

### 创建自定义组件

1. **定义 Model 结构**:
```go
type MyComponent struct {
    // 状态字段
    data     []string
    cursor   int
    keyMap   key.KeyMap
    styles   Styles
}
```

2. **实现 Bubble Tea 接口**:
```go
func (c MyComponent) Init() tea.Cmd {
    return nil
}

func (c MyComponent) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    // 更新逻辑
    return c, nil
}

func (c MyComponent) View() string {
    // 渲染逻辑
    return ""
}
```

3. **提供构造函数**:
```go
func NewMyComponent(opts ...Option) MyComponent {
    return MyComponent{
        // 初始化
    }
}
```

## 总结

Bubbles-CN 项目通过清晰的模块划分，提供了丰富、可复用的终端 UI 组件。每个模块都有明确的职责和接口，可以独立使用或与其他模块组合使用。

### 模块设计原则

1. **单一职责**: 每个模块只负责一个特定的功能
2. **高内聚低耦合**: 模块内部紧密相关，模块间依赖最小化
3. **可组合性**: 模块之间可以自由组合
4. **可扩展性**: 易于扩展和定制
5. **接口标准化**: 遵循统一的接口规范

### 模块使用建议

1. **按需引入**: 只引入需要的模块
2. **组合使用**: 多个模块组合使用构建复杂 UI
3. **自定义样式**: 使用 Lipgloss 自定义组件样式
4. **键绑定统一**: 使用 Key 模块统一管理键盘快捷键
5. **帮助信息**: 使用 Help 模块自动生成帮助菜单
