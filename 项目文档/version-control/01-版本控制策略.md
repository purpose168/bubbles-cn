# Bubbles-CN 版本控制策略

## 概述

本文档制定了 Bubbles-CN 项目的版本控制策略，包括分支管理策略、代码合并流程及版本号命名规则，确保版本管理的规范性和可追溯性。

## 分支管理策略

### 分支结构

```
main (主分支)
  │
  ├── develop (开发分支)
  │     │
  │     ├── feature/* (功能分支)
  │     ├── bugfix/* (修复分支)
  │     └── hotfix/* (紧急修复分支)
  │
  └── release/* (发布分支)
```

### 分支类型

| 分支类型 | 用途 | 命名规范 | 生命周期 |
|---------|------|---------|---------|
| **main** | 主分支，稳定版本 | main | 永久 |
| **develop** | 开发分支，最新开发版本 | develop | 永久 |
| **feature** | 功能开发 | feature/功能名称 | 临时 |
| **bugfix** | Bug 修复 | bugfix/问题描述 | 临时 |
| **hotfix** | 紧急修复 | hotfix/问题描述 | 临时 |
| **release** | 发布准备 | release/版本号 | 临时 |

### 分支说明

#### main 分支

- **用途**: 主分支，包含稳定的生产代码
- **规则**: 
  - 只接受来自 release 分支的合并
  - 每次合并对应一个版本发布
  - 标签使用版本号命名
- **保护**: 设置为受保护分支，需要 Pull Request 和代码审查

#### develop 分支

- **用途**: 开发分支，包含最新的开发代码
- **规则**:
  - 接受来自 feature 和 bugfix 分支的合并
  - 定期合并到 release 分支进行发布准备
- **保护**: 设置为受保护分支，需要 Pull Request 和代码审查

#### feature 分支

- **用途**: 开发新功能
- **命名**: `feature/功能名称`
- **来源**: 从 develop 分支创建
- **目标**: 合并到 develop 分支
- **示例**: `feature/add-paste-support`, `feature/improve-performance`

#### bugfix 分支

- **用途**: 修复 Bug
- **命名**: `bugfix/问题描述`
- **来源**: 从 develop 分支创建
- **目标**: 合并到 develop 分支
- **示例**: `bugfix/fix-cursor-position`, `bugfix/fix-memory-leak`

#### hotfix 分支

- **用途**: 紧急修复生产环境问题
- **命名**: `hotfix/问题描述`
- **来源**: 从 main 分支创建
- **目标**: 合并到 main 和 develop 分支
- **示例**: `hotfix/fix-critical-bug`, `hotfix/security-patch`

#### release 分支

- **用途**: 发布准备
- **命名**: `release/版本号`
- **来源**: 从 develop 分支创建
- **目标**: 合并到 main 分支
- **示例**: `release/v1.0.0`, `release/v1.1.0`

## 分支工作流

### 功能开发流程

```
1. 从 develop 创建 feature 分支
   git checkout develop
   git pull origin develop
   git checkout -b feature/add-paste-support

2. 开发功能
   # 编写代码
   # 编写测试
   # 更新文档

3. 提交代码
   git add .
   git commit -m "feat(textinput): 添加粘贴功能"

4. 推送到远程
   git push origin feature/add-paste-support

5. 创建 Pull Request
   # 在 GitHub 上创建 PR
   # 请求合并到 develop
   # 等待代码审查

6. 合并到 develop
   # 通过审查后合并
   # 删除 feature 分支
```

### Bug 修复流程

```
1. 从 develop 创建 bugfix 分支
   git checkout develop
   git pull origin develop
   git checkout -b bugfix/fix-cursor-position

2. 修复 Bug
   # 编写修复代码
   # 编写测试
   # 更新文档

3. 提交代码
   git add .
   git commit -m "fix(textinput): 修复光标位置计算错误"

4. 推送到远程
   git push origin bugfix/fix-cursor-position

5. 创建 Pull Request
   # 在 GitHub 上创建 PR
   # 请求合并到 develop
   # 等待代码审查

6. 合并到 develop
   # 通过审查后合并
   # 删除 bugfix 分支
```

### 紧急修复流程

```
1. 从 main 创建 hotfix 分支
   git checkout main
   git pull origin main
   git checkout -b hotfix/fix-critical-bug

2. 修复问题
   # 编写修复代码
   # 编写测试
   # 更新文档

3. 提交代码
   git add .
   git commit -m "fix: 修复关键 Bug"

4. 推送到远程
   git push origin hotfix/fix-critical-bug

5. 创建 Pull Request
   # 在 GitHub 上创建 PR
   # 请求合并到 main 和 develop
   # 等待代码审查

6. 合并到 main 和 develop
   # 通过审查后合并到 main
   # 创建版本标签
   # 合并到 develop
   # 删除 hotfix 分支
```

### 发布流程

```
1. 从 develop 创建 release 分支
   git checkout develop
   git pull origin develop
   git checkout -b release/v1.0.0

2. 准备发布
   # 更新版本号
   # 更新 CHANGELOG
   # 运行测试
   # 修复发现的问题

3. 提交代码
   git add .
   git commit -m "chore: 准备 v1.0.0 发布"

4. 推送到远程
   git push origin release/v1.0.0

5. 创建 Pull Request
   # 在 GitHub 上创建 PR
   # 请求合并到 main
   # 等待代码审查

6. 合并到 main
   # 通过审查后合并到 main
   # 创建版本标签
   git tag -a v1.0.0 -m "Release v1.0.0"
   git push origin v1.0.0

7. 合并回 develop
   git checkout develop
   git merge main
   git push origin develop

8. 删除 release 分支
   git branch -d release/v1.0.0
   git push origin --delete release/v1.0.0
```

## 代码合并流程

### Pull Request 流程

#### 1. 创建 Pull Request

- 从 feature/bugfix/hotfix 分支创建 Pull Request
- 选择目标分支（develop 或 main）
- 填写 PR 模板
- 关联相关的 Issue

#### 2. PR 模板

```markdown
## 变更类型
- [ ] 新功能 (feature)
- [ ] Bug 修复 (bugfix)
- [ ] 文档更新 (docs)
- [ ] 代码格式 (style)
- [ ] 重构 (refactor)
- [ ] 性能优化 (perf)
- [ ] 测试 (test)
- [ ] 构建/工具 (chore)

## 变更描述
简要描述变更的内容和目的。

## 变更原因
说明为什么需要这个变更。

## 测试
描述如何测试这个变更。

## 检查清单
- [ ] 代码遵循项目规范
- [ ] 添加了必要的测试
- [ ] 更新了相关文档
- [ ] 所有测试通过
- [ ] 没有引入新的警告

## 相关 Issue
Closes #123
```

#### 3. 代码审查

- 至少一名维护者进行审查
- 审查者提供反馈意见
- 开发者根据反馈进行修改
- 审查通过后批准合并

#### 4. 合并

- 使用 Squash and Merge 合并
- 自动删除源分支
- 合并后关闭相关的 Issue

### 合并策略

| 策略 | 用途 | 优点 | 缺点 |
|------|------|------|------|
| **Squash and Merge** | 功能分支 | 保持历史清晰 | 丢失详细历史 |
| **Merge Commit** | release 分支 | 保留完整历史 | 历史可能混乱 |
| **Rebase and Merge** | 不推荐 | 历史线性 | 可能丢失上下文 |

**推荐**: feature 和 bugfix 分支使用 Squash and Merge，release 分支使用 Merge Commit。

## 版本号命名规则

### 语义化版本 (Semantic Versioning)

Bubbles-CN 使用语义化版本号格式：`MAJOR.MINOR.PATCH`

- **MAJOR**: 主版本号，不兼容的 API 修改
- **MINOR**: 次版本号，向下兼容的功能性新增
- **PATCH**: 修订号，向下兼容的问题修正

### 版本号示例

| 版本号 | 说明 |
|--------|------|
| **v1.0.0** | 初始稳定版本 |
| **v1.1.0** | 添加新功能，向下兼容 |
| **v1.1.1** | 修复 Bug，向下兼容 |
| **v2.0.0** | 不兼容的 API 修改 |

### 预发布版本

预发布版本使用以下后缀：

| 后缀 | 说明 | 示例 |
|------|------|------|
| **alpha** | 内部测试版本 | v1.0.0-alpha.1 |
| **beta** | 公开测试版本 | v1.0.0-beta.1 |
| **rc** | 候选发布版本 | v1.0.0-rc.1 |

### 版本发布流程

#### 1. 版本规划

- 在 develop 分支上开发新功能
- 累积足够的功能后准备发布
- 创建 release 分支

#### 2. 版本测试

- 在 release 分支上进行测试
- 修复发现的问题
- 确保稳定性

#### 3. 版本发布

- 合并到 main 分支
- 创建版本标签
- 更新 CHANGELOG
- 发布到 GitHub

#### 4. 版本通知

- 发布 Release Notes
- 通知用户
- 更新文档

## 提交信息规范

### 提交信息格式

```
<类型>(<范围>): <描述>

[可选的正文]

[可选的脚注]
```

### 提交类型

| 类型 | 说明 | 示例 |
|------|------|------|
| **feat** | 新功能 | `feat(textinput): 添加粘贴功能` |
| **fix** | Bug 修复 | `fix(list): 修复过滤时的索引错误` |
| **docs** | 文档更新 | `docs: 更新 API 文档` |
| **style** | 代码格式 | `style: 格式化代码` |
| **refactor** | 重构 | `refactor(table): 重构渲染逻辑` |
| **perf** | 性能优化 | `perf(textinput): 优化渲染性能` |
| **test** | 测试相关 | `test: 添加单元测试` |
| **chore** | 构建/工具 | `chore: 更新依赖` |

### 提交范围

| 范围 | 说明 |
|------|------|
| **textinput** | 文本输入组件 |
| **textarea** | 文本区域组件 |
| **list** | 列表组件 |
| **table** | 表格组件 |
| **viewport** | 视口组件 |
| **spinner** | 加载动画组件 |
| **progress** | 进度条组件 |
| **paginator** | 分页器组件 |
| **filepicker** | 文件选择器组件 |
| **timer** | 定时器组件 |
| **stopwatch** | 秒表组件 |
| **help** | 帮助组件 |
| **key** | 键绑定组件 |
| **cursor** | 光标组件 |
| **runeutil** | 字符工具 |

### 提交示例

#### 新功能

```
feat(textinput): 添加粘贴功能

实现了剪贴板粘贴功能，支持 Ctrl+V 快捷键。
使用 atotto/clipboard 库实现跨平台剪贴板访问。

Closes #123
```

#### Bug 修复

```
fix(list): 修复过滤时的索引错误

修复了在过滤列表后，光标位置计算错误的问题。
现在光标会正确地保持在第一个可见项目上。

Fixes #456
```

#### 文档更新

```
docs: 更新 API 文档

更新了 textinput 组件的 API 文档，
添加了新的方法和参数说明。
```

#### 性能优化

```
perf(table): 优化渲染性能

使用 strings.Builder 替代字符串拼接，
减少内存分配，提高渲染性能约 30%。
```

## 标签管理

### 标签命名

- 使用版本号作为标签名
- 添加 `v` 前缀
- 使用带注释的标签

### 标签示例

```bash
# 创建标签
git tag -a v1.0.0 -m "Release v1.0.0"

# 推送标签
git push origin v1.0.0

# 推送所有标签
git push origin --tags

# 删除标签
git tag -d v1.0.0
git push origin --delete v1.0.0
```

### 标签类型

| 标签类型 | 用途 | 示例 |
|---------|------|------|
| **正式版本** | 稳定版本 | v1.0.0, v1.1.0 |
| **预发布版本** | 测试版本 | v1.0.0-alpha.1, v1.0.0-beta.1 |
| **里程碑** | 重要里程碑 | v0.1.0-milestone |

## 变更日志 (CHANGELOG)

### CHANGELOG 格式

```markdown
# Changelog

## [Unreleased]

### Added
- 新功能列表

### Changed
- 变更列表

### Deprecated
- 废弃列表

### Removed
- 移除列表

### Fixed
- 修复列表

### Security
- 安全修复列表

## [1.0.0] - 2024-01-01

### Added
- 初始版本
```

### CHANGELOG 维护

- 每次发布时更新 CHANGELOG
- 记录所有重要变更
- 使用语义化版本号
- 包含发布日期

## 版本回退

### 回退到指定版本

```bash
# 查看历史
git log --oneline

# 回退到指定版本（保留更改）
git revert <commit-hash>

# 回退到指定版本（不保留更改）
git reset --hard <commit-hash>

# 推送到远程
git push origin main --force
```

### 紧急回退

```bash
# 创建回退分支
git checkout -b hotfix/rollback-v1.0.0

# 回退到上一个版本
git reset --hard v0.9.0

# 推送并发布
git push origin hotfix/rollback-v1.0.0
```

## 总结

Bubbles-CN 项目采用严格的版本控制策略，确保版本管理的规范性和可追溯性。开发者应该遵循分支管理策略、代码合并流程和版本号命名规则。

### 版本控制要点

1. **分支管理**: 使用规范的分支结构
2. **代码合并**: 使用 Pull Request 进行代码审查
3. **版本号**: 使用语义化版本号
4. **提交信息**: 使用规范的提交信息格式
5. **标签管理**: 使用版本号作为标签
6. **变更日志**: 维护详细的 CHANGELOG

### 最佳实践

1. **小步提交**: 频繁提交，每次提交包含一个逻辑单元
2. **清晰描述**: 提交信息清晰描述变更内容
3. **代码审查**: 所有代码都需要经过审查
4. **版本标记**: 每次发布都创建版本标签
5. **文档同步**: 保持文档与代码同步
6. **持续改进**: 根据反馈持续改进版本控制流程
