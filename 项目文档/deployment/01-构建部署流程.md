# Bubbles-CN 构建部署流程

## 概述

本文档提供了 Bubbles-CN 项目的详细构建步骤、部署流程及环境变量配置，帮助开发者和用户正确构建和部署项目。

## 环境要求

### 开发环境

| 组件 | 版本要求 | 说明 |
|------|---------|------|
| **Go** | 1.24.2 或更高 | 主要开发语言 |
| **Git** | 2.0 或更高 | 版本控制 |
| **Make** | 3.81 或更高 | 构建工具 |
| **golangci-lint** | 最新版本 | 代码检查（可选） |

### 操作系统支持

| 操作系统 | 支持状态 | 说明 |
|---------|---------|------|
| **Linux** | ✅ 完全支持 | Ubuntu 20.04+, Debian 10+, CentOS 8+ |
| **macOS** | ✅ 完全支持 | macOS 11+ (Big Sur 或更高） |
| **Windows** | ✅ 完全支持 | Windows 10+ |

### 终端要求

- 支持 ANSI 转义序列
- 支持 256 色或真彩色（推荐）
- 备用屏幕缓冲区（可选，用于高性能模式）

## 环境配置

### Go 环境配置

#### 1. 安装 Go

**Linux/macOS**:
```bash
# 下载 Go
wget https://go.dev/dl/go1.24.2.linux-amd64.tar.gz

# 解压到 /usr/local
sudo tar -C /usr/local -xzf go1.24.2.linux-amd64.tar.gz

# 配置环境变量
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
echo 'export GOPATH=$HOME/go' >> ~/.bashrc
source ~/.bashrc

# 验证安装
go version
```

**Windows**:
1. 下载 Go 安装程序：https://go.dev/dl/
2. 运行安装程序，按照提示完成安装
3. 重启命令提示符
4. 验证安装：`go version`

#### 2. 配置 Go 模块

```bash
# 设置 Go 模块代理（可选，用于国内用户）
go env -w GOPROXY=https://goproxy.cn,direct

# 设置 Go 模块校验和数据库
go env -w GOSUMDB=sum.golang.google.cn

# 设置 Go 模块私有路径（如果使用私有仓库）
go env -w GOPRIVATE=github.com/purpose168
```

### Git 配置

```bash
# 配置用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 配置默认分支名
git config --global init.defaultBranch main

# 配置换行符（Windows）
git config --global core.autocrlf true

# 配置换行符（Linux/macOS）
git config --global core.autocrlf input
```

### 工具安装

#### 安装 golangci-lint

```bash
# Linux/macOS
curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin

# 添加到 PATH
echo 'export PATH=$PATH:$(go env GOPATH)/bin' >> ~/.bashrc
source ~/.bashrc

# 验证安装
golangci-lint version
```

#### 安装 goimports

```bash
go install golang.org/x/tools/cmd/goimports@latest

# 添加到 PATH
echo 'export PATH=$PATH:$(go env GOPATH)/bin' >> ~/.bashrc
source ~/.bashrc
```

## 项目构建

### 克隆项目

```bash
# 克隆仓库
git clone https://github.com/purpose168/bubbles-cn.git
cd bubbles-cn

# 或者使用 SSH
git clone git@github.com:purpose168/bubbles-cn.git
cd bubbles-cn
```

### 依赖管理

```bash
# 初始化模块（如果需要）
make init

# 整理依赖
make tidy

# 验证依赖
make verify

# 查看依赖树
make deptree
```

### 代码检查

```bash
# 格式化代码
make format

# 检查代码质量
make lint

# 运行 go vet
go vet ./...
```

### 运行测试

```bash
# 运行所有测试
make test

# 运行测试并显示覆盖率
go test -cover ./...

# 运行测试并检测竞态条件
go test -race ./...

# 运行特定包的测试
go test ./textinput

# 运行特定测试函数
go test -run TestNew ./textinput
```

### 构建项目

```bash
# 构建所有组件
make build

# 构建特定组件
cd textinput && go build ./...

# 构建并安装到 GOPATH/bin
go install ./...

# 交叉编译
# Linux
GOOS=linux GOARCH=amd64 go build ./...

# macOS
GOOS=darwin GOARCH=amd64 go build ./...
GOOS=darwin GOARCH=arm64 go build ./...

# Windows
GOOS=windows GOARCH=amd64 go build ./...
```

## 部署流程

### 本地部署

#### 1. 作为库使用

```bash
# 在你的项目中引用
go get github.com/purpose168/bubbles-cn

# 或者使用本地路径
go mod edit -replace github.com/purpose168/bubbles-cn=/path/to/bubbles-cn
```

#### 2. 运行示例

```bash
# 克隆示例项目
git clone https://github.com/purpose168/bubbletea-cn-examples.git
cd bubbletea-cn-examples

# 运行示例
go run examples/textinput/main.go
```

### 生产部署

#### 1. 版本发布

```bash
# 创建发布分支
git checkout -b release/v1.0.0

# 更新版本号
# 编辑 go.mod 文件，更新版本号

# 提交更改
git add go.mod
git commit -m "chore: bump version to v1.0.0"

# 创建标签
git tag -a v1.0.0 -m "Release v1.0.0"

# 推送标签
git push origin v1.0.0

# 推送到主分支
git checkout main
git merge release/v1.0.0
git push origin main
```

#### 2. 使用 GoReleaser

Bubbles-CN 使用 GoReleaser 自动化发布流程。

**配置文件**: `.goreleaser.yml`

```yaml
# 示例配置
project_name: bubbles-cn
before:
  hooks:
    - go mod tidy
builds:
  - env:
      - CGO_ENABLED=0
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ldflags:
      - -s -w -X main.version={{.Version}}
archives:
  - format: tar.gz
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
checksum:
  name_template: "{{ .ProjectName }}_{{ .Version }}_checksums.txt"
changelog:
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
```

**执行发布**:

```bash
# 安装 GoReleaser
go install github.com/goreleaser/goreleaser/v2/cmd/goreleaser@latest

# 测试发布（不实际发布）
goreleaser release --snapshot --rm-dist

# 实际发布
goreleaser release
```

### Docker 部署

#### 1. 创建 Dockerfile

```dockerfile
# 构建阶段
FROM golang:1.24.2-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY go.mod go.sum ./
RUN go mod download

# 复制源代码
COPY . .

# 构建应用
RUN CGO_ENABLED=0 GOOS=linux go build -o app ./...

# 运行阶段
FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /root/

# 从构建阶段复制二进制文件
COPY --from=builder /app/app .

# 设置入口点
ENTRYPOINT ["./app"]
```

#### 2. 构建镜像

```bash
# 构建镜像
docker build -t bubbles-cn:latest .

# 运行容器
docker run -it --rm bubbles-cn:latest
```

### CI/CD 部署

Bubbles-CN 使用 GitHub Actions 进行 CI/CD。

**工作流文件**: `.github/workflows/build.yml`

```yaml
name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.2'
      
      - name: Install dependencies
        run: go mod download
      
      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
  
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.2'
      
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
```

## 环境变量配置

### Go 环境变量

| 变量名 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| **GOPATH** | Go 工作目录 | `$HOME/go` | `/home/user/go` |
| **GOROOT** | Go 安装目录 | 自动检测 | `/usr/local/go` |
| **GOPROXY** | Go 模块代理 | `https://proxy.golang.org,direct` | `https://goproxy.cn,direct` |
| **GOSUMDB** | 校验和数据库 | `sum.golang.org` | `sum.golang.google.cn` |
| **GOPRIVATE** | 私有模块路径 | 空 | `github.com/purpose168` |
| **GO111MODULE** | Go 模块模式 | `auto` | `on` |

### 项目环境变量

| 变量名 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| **BUBBLES_DEBUG** | 调试模式 | `false` | `true` |
| **BUBBLES_LOG_LEVEL** | 日志级别 | `info` | `debug` |
| **BUBBLES_CONFIG** | 配置文件路径 | 空 | `/path/to/config.yml` |

### 配置示例

**Linux/macOS** (`~/.bashrc` 或 `~/.zshrc`):

```bash
# Go 环境变量
export PATH=$PATH:/usr/local/go/bin
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin
export GOPROXY=https://goproxy.cn,direct
export GOSUMDB=sum.golang.google.cn

# 项目环境变量
export BUBBLES_DEBUG=false
export BUBBLES_LOG_LEVEL=info
```

**Windows** (系统环境变量):

```
PATH=%PATH%;C:\Go\bin
GOPATH=C:\Users\YourName\go
GOPROXY=https://goproxy.cn,direct
GOSUMDB=sum.golang.google.cn
```

## 构建脚本

### Makefile

Bubbles-CN 提供了 Makefile 来简化构建过程。

**可用命令**:

```bash
make help          # 显示帮助信息
make init          # 初始化模块
make test          # 运行测试
make tidy          # 整理依赖
make format        # 格式化代码
make lint          # 检查代码质量
make clean         # 清理构建产物
make verify        # 验证依赖
make deptree       # 显示依赖树
make build         # 构建项目
```

### Shell 脚本

**build.sh**:

```bash
#!/bin/bash

set -e

echo "Building Bubbles-CN..."

# 设置环境变量
export CGO_ENABLED=0

# 构建所有组件
for component in cursor timer textinput textarea viewport table stopwatch spinner progress list paginator key help filepicker; do
    echo "Building $component..."
    cd $component
    go build -o ../../bin/$component ./...
    cd ..
done

echo "Build complete!"
```

**使用**:

```bash
chmod +x build.sh
./build.sh
```

## 常见构建问题

### 依赖问题

#### 问题 1: 依赖下载失败

**症状**:
```
go: github.com/purpose168/bubbletea-cn@v0.0.0: reading github.com/purpose168/bubbletea-cn/go.mod at revision v0.0.0: unknown revision v0.0.0
```

**解决方案**:
```bash
# 使用本地依赖
go mod edit -replace github.com/purpose168/bubbletea-cn=../bubbletea-cn
go mod tidy
```

#### 问题 2: 依赖版本冲突

**症状**:
```
go: github.com/purpose168/bubbletea-cn@v0.0.0 requires github.com/purpose168/lipgloss-cn@v0.0.0: conflicting versions
```

**解决方案**:
```bash
# 清理依赖缓存
go clean -modcache

# 重新下载依赖
go mod download

# 整理依赖
go mod tidy
```

### 编译问题

#### 问题 1: 编译错误

**症状**:
```
# github.com/purpose168/bubbles-cn/textinput
textinput/textinput.go:123: undefined: cursor.Model
```

**解决方案**:
```bash
# 检查依赖是否正确
go mod verify

# 重新下载依赖
go mod download

# 整理依赖
go mod tidy
```

#### 问题 2: 交叉编译失败

**症状**:
```
go build: cannot load github.com/purpose168/bubbles-cn/textinput: no matching Go files in directory
```

**解决方案**:
```bash
# 确保设置了正确的 GOOS 和 GOARCH
export GOOS=linux
export GOARCH=amd64

# 清理构建缓存
go clean -cache

# 重新构建
go build ./...
```

### 测试问题

#### 问题 1: 测试失败

**症状**:
```
--- FAIL: TestNew (0.00s)
    textinput_test.go:23: expected prompt '> ', got '>'
```

**解决方案**:
```bash
# 运行测试并显示详细输出
go test -v ./textinput

# 运行测试并显示覆盖率
go test -coverprofile=coverage.out ./textinput

# 查看覆盖率报告
go tool cover -html=coverage.out
```

#### 问题 2: 竞态条件

**症状**:
```
WARNING: DATA RACE
Read at 0x00c0000a4010 by goroutine 7:
```

**解决方案**:
```bash
# 运行测试并检测竞态条件
go test -race ./...

# 修复竞态条件后重新测试
go test ./...
```

## 性能优化

### 编译优化

```bash
# 使用编译优化标志
go build -ldflags="-s -w" ./...

# -s: 去除符号表
# -w: 去除 DWARF 调试信息
```

### 缓存优化

```bash
# 使用构建缓存
go build -cache ./...

# 禁用构建缓存（调试时使用）
go build -nocache ./...
```

### 并行编译

```bash
# 使用并行编译
go build -p 4 ./...

# -p: 并行编译的包数量
```

## 监控和日志

### 日志配置

```go
import "log"

// 配置日志
func init() {
    log.SetFlags(log.LstdFlags | log.Lshortfile)
    log.SetOutput(os.Stdout)
}
```

### 性能监控

```go
import (
    "runtime"
    "time"
)

// 性能监控
func monitorPerformance() {
    var m runtime.MemStats
    runtime.ReadMemStats(&m)
    log.Printf("Alloc = %v MiB", m.Alloc/1024/1024)
    log.Printf("TotalAlloc = %v MiB", m.TotalAlloc/1024/1024)
    log.Printf("Sys = %v MiB", m.Sys/1024/1024)
    log.Printf("NumGC = %v", m.NumGC)
}
```

## 总结

Bubbles-CN 项目的构建和部署流程简单明了，使用标准的 Go 工具链和 Makefile 自动化构建过程。开发者可以根据需要选择本地构建、Docker 部署或 CI/CD 自动化部署。

### 构建部署要点

1. **环境准备**: 确保安装了必要的工具和依赖
2. **依赖管理**: 使用 Go Modules 管理依赖
3. **代码质量**: 运行测试和代码检查
4. **版本控制**: 使用 Git 进行版本控制
5. **自动化部署**: 使用 CI/CD 自动化部署流程
6. **监控日志**: 配置日志和性能监控

### 最佳实践

1. **使用 Makefile**: 简化构建过程
2. **编写测试**: 确保代码质量
3. **代码审查**: 所有代码都需要经过审查
4. **版本标记**: 使用语义化版本号
5. **文档完善**: 保持文档与代码同步
6. **持续改进**: 根据反馈持续改进构建流程
