# Bubbles-CN 数据流程文档

## 概述

本文档详细说明了 Bubbles-CN 项目中关键业务流程的数据流转过程，包括数据在各模块间的传递、状态管理和事件处理机制。

## 整体数据流架构

### MVU 架构数据流

Bubbles-CN 基于 Bubble Tea 的 Elm 架构（MVU），数据流遵循以下模式：

```
用户输入
   │
   ▼
┌─────────────┐
│  tea.KeyMsg │ (消息)
└─────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│         Bubble Tea Runtime           │
│         (消息分发器)                  │
└─────────────────────────────────────┘
   │
   ├──────────────────┬──────────────────┐
   ▼                  ▼                  ▼
┌──────────┐      ┌──────────┐      ┌──────────┐
│Component │      │Component │      │Component │
│  Model   │      │  Model   │      │  Model   │
└──────────┘      └──────────┘      └──────────┘
   │                  │                  │
   ▼                  ▼                  ▼
┌──────────┐      ┌──────────┐      ┌──────────┐
│  Update  │      │  Update  │      │  Update  │
│  (更新)  │      │  (更新)  │      │  (更新)  │
└──────────┘      └──────────┘      └──────────┘
   │                  │                  │
   ▼                  ▼                  ▼
┌──────────┐      ┌──────────┐      ┌──────────┐
│  View    │      │  View    │      │  View    │
│  (渲染)  │      │  (渲染)  │      │  (渲染)  │
└──────────┘      └──────────┘      └──────────┘
   │                  │                  │
   └──────────────────┴──────────────────┘
                  │
                  ▼
         ┌─────────────┐
         │  渲染输出    │
         │  (String)   │
         └─────────────┘
```

## 核心数据流程

### 1. TextInput 数据流程

#### 数据结构

```go
type Model struct {
    Err            error         // 验证错误
    Prompt         string        // 提示符
    Placeholder    string        // 占位符
    EchoMode       EchoMode      // 回显模式
    EchoCharacter rune          // 回显字符
    Cursor         cursor.Model  // 光标模型
    Value          string        // 当前值
    Width          int           // 宽度
    CharLimit      int           // 字符限制
    Validate       ValidateFunc  // 验证函数
}
```

#### 数据流程图

```
用户按键
   │
   ▼
┌─────────────────────────────────────┐
│       tea.KeyMsg (按键消息)          │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│       TextInput.Update()             │
└─────────────────────────────────────┘
   │
   ├──────────────────────────────────┤
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│  字符输入     │              │  光标移动     │
│  (插入/删除)  │              │  (左/右/首/尾)│
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 更新 Value    │              │ 更新 Cursor   │
│ 和 Cursor     │              │ 位置         │
└──────────────┘              └──────────────┘
   │                                  │
   └──────────────────┬───────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │   验证输入        │
           │ (ValidateFunc)   │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │ 更新 Err 字段     │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  TextInput.View() │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  渲染输出         │
           │  (String)         │
           └──────────────────┘
```

#### 关键数据转换

| 输入 | 处理 | 输出 |
|------|------|------|
| 字符按键 | 插入到 Value | 更新后的 Value |
| 退格键 | 删除光标前字符 | 更新后的 Value |
| 删除键 | 删除光标后字符 | 更新后的 Value |
| 方向键 | 移动光标位置 | 更新后的 Cursor |
| Ctrl+V | 粘贴剪贴板内容 | 更新后的 Value |
| 验证函数 | 验证 Value | Err 或 nil |

### 2. List 数据流程

#### 数据结构

```go
type Model struct {
    KeyMap       key.KeyMap   // 键绑定
    Title        string       // 标题
    Items        []Item       // 列表项
    Cursor       int          // 光标位置
    SelectedItem Item         // 选中的项
    FilterState  FilterState  // 过滤状态
    Paginator    paginator.Model // 分页器
    ShowHelp     bool         // 是否显示帮助
}
```

#### 数据流程图

```
用户按键
   │
   ▼
┌─────────────────────────────────────┐
│       tea.KeyMsg (按键消息)          │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│         List.Update()               │
└─────────────────────────────────────┘
   │
   ├──────────────────────────────────┤
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│  导航操作     │              │  过滤操作     │
│  (上下移动)   │              │  (搜索/过滤)  │
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 更新 Cursor  │              │ 过滤 Items    │
│ 和 Selected  │              │ 生成过滤列表   │
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 更新分页器    │              │ 更新过滤状态   │
│ Paginator    │              │ FilterState  │
└──────────────┘              └──────────────┘
   │                                  │
   └──────────────────┬───────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │   List.View()    │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  渲染输出         │
           │  (String)        │
           └──────────────────┘
```

#### 过滤数据流程

```
用户输入过滤文本
   │
   ▼
┌─────────────────────────────────────┐
│   TextInput (过滤输入框)              │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   FilterFunc (过滤函数)               │
│   - 遍历所有 Items                    │
│   - 调用 Item.FilterValue()           │
│   - 计算匹配度                        │
│   - 排序结果                          │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   filteredItems (过滤后的列表)        │
│   - index: 原始索引                    │
│   - item: 匹配的项                    │
│   - matches: 匹配的字符位置            │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   更新 FilterState                   │
│   - 设置过滤状态                      │
│   - 更新显示的项                      │
└─────────────────────────────────────┘
```

### 3. Table 数据流程

#### 数据结构

```go
type Model struct {
    KeyMap  KeyMap     // 键绑定
    Help    help.Model // 帮助模型
    cols    []Column   // 列定义
    rows    []Row      // 行数据
    cursor  int        // 光标位置
    focus   bool       // 是否聚焦
    styles  Styles     // 样式
    viewport viewport.Model // 视口
    start   int        // 起始行
    end     int        // 结束行
}
```

#### 数据流程图

```
用户按键
   │
   ▼
┌─────────────────────────────────────┐
│       tea.KeyMsg (按键消息)          │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│         Table.Update()              │
└─────────────────────────────────────┘
   │
   ├──────────────────────────────────┤
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│  行导航       │              │  页面导航     │
│  (上下移动)   │              │  (翻页/跳转)  │
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 更新 Cursor   │              │ 更新 Viewport │
│ 位置         │              │ 偏移量        │
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 计算可见行    │              │ 更新 start/end│
│ (start/end)  │              │ 索引          │
└──────────────┘              └──────────────┘
   │                                  │
   └──────────────────┬───────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │   Table.View()   │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  渲染输出         │
           │  (String)        │
           └──────────────────┘
```

#### 表格渲染流程

```
Table.View()
   │
   ▼
┌─────────────────────────────────────┐
│   1. 渲染表头                         │
│      - 遍历 cols                      │
│      - 应用样式                       │
│      - 添加边框                       │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   2. 渲染可见行                       │
│      - 从 start 到 end               │
│      - 遍历每行的列                    │
│      - 应用样式（聚焦/未聚焦）          │
│      - 处理文本截断                    │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   3. 渲染边框（如果启用）              │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   4. 渲染帮助信息（如果启用）          │
└─────────────────────────────────────┘
   │
   ▼
   返回渲染结果
```

### 4. Viewport 数据流程

#### 数据结构

```go
type Model struct {
    KeyMap  KeyMap       // 键绑定
    YOffset int          // Y 偏移量
    YPosition int        // Y 位置
    Height  int          // 高度
    Width   int          // 宽度
    HighPerformanceViewport bool // 高性能模式
}
```

#### 数据流程图

```
设置内容
   │
   ▼
┌─────────────────────────────────────┐
│   SetContent(content string)        │
│   - 计算内容行数                      │
│   - 计算内容高度                      │
│   - 存储内容                          │
└─────────────────────────────────────┘
   │
   ▼
用户按键
   │
   ▼
┌─────────────────────────────────────┐
│       tea.KeyMsg (按键消息)          │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│         Viewport.Update()           │
└─────────────────────────────────────┘
   │
   ├──────────────────────────────────┤
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│  行滚动       │              │  页面滚动     │
│  (上下移动)   │              │  (翻页)       │
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 更新 YOffset  │              │ 更新 YOffset  │
│ (逐行调整)    │              │ (页面调整)     │
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 限制范围      │              │ 限制范围      │
│ (0-max)      │              │ (0-max)      │
└──────────────┘              └──────────────┘
   │                                  │
   └──────────────────┬───────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  Viewport.View() │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  计算可见行      │
           │  (基于 YOffset)  │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  渲染输出         │
           │  (String)        │
           └──────────────────┘
```

### 5. FilePicker 数据流程

#### 数据结构

```go
type Model struct {
    CurrentDirectory string        // 当前目录
    SelectedFiles    []string      // 选中的文件
    ShowPermissions  bool           // 是否显示权限
    ShowSize         bool           // 是否显示大小
    ShowHidden       bool           // 是否显示隐藏文件
    AutoHeight       bool           // 自动高度
    Cursor           cursor.Model   // 光标模型
    FileAllowed      FileFilter     // 文件过滤器
    DirAllowed       FileFilter     // 目录过滤器
}
```

#### 数据流程图

```
初始化
   │
   ▼
┌─────────────────────────────────────┐
│   SetCurrentDirectory(path)         │
│   - 验证路径                          │
│   - 读取目录内容                      │
│   - 过滤文件和目录                    │
│   - 排序结果                          │
└─────────────────────────────────────┘
   │
   ▼
用户按键
   │
   ▼
┌─────────────────────────────────────┐
│       tea.KeyMsg (按键消息)          │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│         FilePicker.Update()          │
└─────────────────────────────────────┘
   │
   ├──────────────────────────────────┤
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│  导航操作     │              │  选择操作     │
│  (上下移动)   │              │  (Enter)      │
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 更新 Cursor   │              │ 检查选中项    │
│ 位置         │              │ 类型          │
└──────────────┘              └──────────────┘
   │                                  │
   │                                  ▼
   │                          ┌──────────────┐
   │                          │ 是目录?       │
   │                          └──────────────┘
   │                                  │
   │                    ┌─────────────┴─────────────┐
   │                    │                           │
   │                    ▼                           ▼
   │            ┌──────────────┐            ┌──────────────┐
   │            │ 进入目录      │            │ 选择文件      │
   │            │ 重新读取      │            │ 添加到选中    │
   │            │ 目录内容      │            │ 列表          │
   │            └──────────────┘            └──────────────┘
   │                    │                           │
   └────────────────────┴───────────────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │ FilePicker.View()│
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  渲染文件列表    │
           │  (String)        │
           └──────────────────┘
```

#### 目录读取流程

```
SetCurrentDirectory(path)
   │
   ▼
┌─────────────────────────────────────┐
│   1. 验证路径                        │
│      - 检查路径是否存在                │
│      - 检查是否为目录                  │
│      - 检查访问权限                    │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   2. 读取目录内容                    │
│      - os.ReadDir()                  │
│      - 获取所有文件和目录               │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   3. 过滤文件                        │
│      - 应用 FileAllowed 过滤器         │
│      - 应用 DirAllowed 过滤器          │
│      - 过滤隐藏文件（如果 ShowHidden=false）│
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   4. 排序结果                        │
│      - 目录优先                       │
│      - 按名称排序                      │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   5. 更新模型状态                    │
│      - 更新 CurrentDirectory         │
│      - 重置 Cursor                   │
│      - 清空 SelectedFiles            │
└─────────────────────────────────────┘
```

### 6. Timer 数据流程

#### 数据结构

```go
type Model struct {
    Timeout      time.Duration   // 超时时间
    Interval     time.Duration   // 更新间隔
    StartTime    time.Time       // 开始时间
    Style        lipgloss.Style  // 样式
}
```

#### 数据流程图

```
初始化
   │
   ▼
┌─────────────────────────────────────┐
│   New(opts...)                      │
│   - 设置 Timeout                    │
│   - 设置 Interval                   │
│   - 初始化 StartTime                │
└─────────────────────────────────────┘
   │
   ▼
启动计时器
   │
   ▼
┌─────────────────────────────────────┐
│   Start()                           │
│   - 设置 StartTime = time.Now()     │
│   - 返回 Tick 命令                   │
└─────────────────────────────────────┘
   │
   ▼
定时器触发
   │
   ▼
┌─────────────────────────────────────┐
│   timer.TickMsg                     │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   Timer.Update(msg)                 │
└─────────────────────────────────────┘
   │
   ├──────────────────────────────────┤
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│  TickMsg     │              │  TimeoutMsg  │
│  (定时更新)    │              │  (超时)       │
└──────────────┘              └──────────────┘
   │                                  │
   ▼                                  ▼
┌──────────────┐              ┌──────────────┐
│ 继续计时      │              │ 停止计时      │
│ 返回 Tick 命令│              │ 返回 nil     │
└──────────────┘              └──────────────┘
   │                                  │
   └──────────────────┬───────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │   Timer.View()   │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  计算剩余时间     │
           │  格式化输出       │
           └──────────────────┘
                      │
                      ▼
           ┌──────────────────┐
           │  渲染输出         │
           │  (String)        │
           └──────────────────┘
```

### 7. Progress 数据流程

#### 数据结构

```go
type Model struct {
    Percent         float64        // 进度百分比 (0.0-1.0)
    Width           int            // 宽度
    Full            *lipgloss.Style // 填充样式
    Empty           *lipgloss.Style // 空样式
    Head            *lipgloss.Style // 头部样式
    ShowPercentage  bool           // 是否显示百分比
}
```

#### 数据流程图

```
初始化
   │
   ▼
┌─────────────────────────────────────┐
│   New(opts...)                      │
│   - 设置 Width                      │
│   - 设置样式                         │
│   - 初始化 Percent = 0.0            │
└─────────────────────────────────────┘
   │
   ▼
更新进度
   │
   ▼
┌─────────────────────────────────────┐
│   SetPercent(p) 或 IncrPercent(delta)│
│   - 更新 Percent                    │
│   - 限制范围 [0.0, 1.0]              │
└─────────────────────────────────────┘
   │
   ▼
动画更新（如果启用）
   │
   ▼
┌─────────────────────────────────────┐
│   harmonica 动画                     │
│   - 计算动画帧                       │
│   - 更新样式                         │
└─────────────────────────────────────┘
   │
   ▼
渲染
   │
   ▼
┌─────────────────────────────────────┐
│   Progress.View()                   │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   1. 计算填充宽度                    │
│      filledWidth = int(Percent * Width)│
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   2. 渲染空部分                      │
│      - 应用 Empty 样式                │
│      - 重复空字符                      │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   3. 渲染填充部分                    │
│      - 应用 Full 样式                 │
│      - 重复填充字符                    │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   4. 渲染头部（如果启用）              │
│      - 应用 Head 样式                 │
│      - 在填充部分末尾添加头部字符        │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   5. 渲染百分比（如果启用）            │
│      - 格式化百分比                    │
│      - 添加到进度条后                  │
└─────────────────────────────────────┘
   │
   ▼
   返回渲染结果
```

## 组件间数据交互

### 组件组合数据流

```
┌─────────────────────────────────────────────────────────┐
│                    应用程序 (App)                         │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  App.Update(msg)                         │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ TextInput    │  │ List         │  │ Help         │
│ .Update(msg) │  │ .Update(msg) │  │ .Update(msg) │
└──────────────┘  └──────────────┘  └──────────────┘
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ (Model, Cmd) │  │ (Model, Cmd) │  │ (Model, Cmd) │
└──────────────┘  └──────────────┘  └──────────────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  App.View()                             │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ TextInput    │  │ List         │  │ Help         │
│ .View()      │  │ .View()      │  │ .View()      │
└──────────────┘  └──────────────┘  └──────────────┘
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ (String)     │  │ (String)     │  │ (String)     │
└──────────────┘  └──────────────┘  └──────────────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│              组合渲染结果 (lipgloss.Join)                │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
                   最终渲染输出
```

### 消息传递示例

```go
// 应用程序模型
type AppModel struct {
    textInput textinput.Model
    list      list.Model
    help      help.Model
}

// 更新函数
func (m AppModel) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    var cmd tea.Cmd
    
    // 更新所有组件
    m.textInput, cmd = m.textInput.Update(msg)
    
    // 如果文本输入有命令，执行它
    if cmd != nil {
        return m, cmd
    }
    
    m.list, cmd = m.list.Update(msg)
    
    // 如果列表有命令，执行它
    if cmd != nil {
        return m, cmd
    }
    
    m.help, _ = m.help.Update(msg)
    
    return m, cmd
}

// 视图函数
func (m AppModel) View() string {
    return lipgloss.JoinVertical(
        lipgloss.Left,
        m.textInput.View(),
        m.list.View(),
        m.help.View(),
    )
}
```

## 状态管理

### 状态流转

```
初始状态
   │
   ▼
┌─────────────────────────────────────┐
│   Init()                            │
│   - 初始化模型                       │
│   - 返回初始命令                     │
└─────────────────────────────────────┘
   │
   ▼
运行状态
   │
   ▼
┌─────────────────────────────────────┐
│   Update(msg)                       │
│   - 处理消息                         │
│   - 更新状态                         │
│   - 返回命令                         │
└─────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────┐
│   View()                            │
│   - 渲染当前状态                     │
│   - 返回渲染结果                     │
└─────────────────────────────────────┘
   │
   ▼
退出状态
   │
   ▼
┌─────────────────────────────────────┐
│   tea.Quit                          │
│   - 退出程序                         │
└─────────────────────────────────────┘
```

### 状态同步

当多个组件需要共享状态时，可以通过以下方式实现：

1. **父组件管理状态**
```go
type AppModel struct {
    sharedState string
    componentA  ComponentA
    componentB  ComponentB
}

func (m AppModel) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    // 更新共享状态
    // 传递给子组件
    m.componentA = m.componentA.WithState(m.sharedState)
    m.componentB = m.componentB.WithState(m.sharedState)
    return m, nil
}
```

2. **消息传递**
```go
// 定义自定义消息
type StateUpdateMsg struct {
    NewState string
}

// 组件 A 发送状态更新
func (m ComponentA) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    // 更新状态
    // 发送消息
    return m, func() tea.Msg {
        return StateUpdateMsg{NewState: "new state"}
    }
}

// 父组件接收并更新
func (m AppModel) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    switch msg := msg.(type) {
    case StateUpdateMsg:
        m.sharedState = msg.NewState
        // 更新其他组件
    }
    return m, nil
}
```

## 性能优化数据流

### 增量渲染

```
完整渲染
   │
   ▼
┌─────────────────────────────────────┐
│   View()                            │
│   - 计算所有内容                     │
│   - 生成完整字符串                   │
└─────────────────────────────────────┘
   │
   ▼
   输出到终端

增量渲染（优化）
   │
   ▼
┌─────────────────────────────────────┐
│   View()                            │
│   - 检测变化的部分                   │
│   - 只渲染变化的部分                 │
│   - 使用 ANSI 转义序列定位           │
└─────────────────────────────────────┘
   │
   ▼
   输出到终端
```

### 视口优化

```
完整内容渲染
   │
   ▼
┌─────────────────────────────────────┐
│   渲染所有行                        │
│   - 即使不可见也渲染                 │
│   - 浪费资源                        │
└─────────────────────────────────────┘
   │
   ▼
   输出到终端

视口优化渲染
   │
   ▼
┌─────────────────────────────────────┐
│   只渲染可见行                       │
│   - 基于 YOffset                    │
│   - 基于 Height                     │
│   - 节省资源                        │
└─────────────────────────────────────┘
   │
   ▼
   输出到终端
```

## 总结

Bubbles-CN 的数据流基于 Bubble Tea 的 MVU 架构，通过消息传递实现状态更新和视图渲染。每个组件独立管理自己的状态，通过组合使用构建复杂的终端用户界面。

### 数据流特点

1. **单向数据流**: 数据从用户输入流向视图输出
2. **消息驱动**: 所有状态更新通过消息触发
3. **组件独立**: 每个组件管理自己的状态
4. **可组合**: 组件之间可以自由组合
5. **性能优化**: 支持增量渲染和视口优化

### 最佳实践

1. **保持状态简单**: 避免复杂的状态嵌套
2. **使用不可变数据**: 返回新的模型而不是修改现有模型
3. **合理使用命令**: 只在需要时返回命令
4. **优化渲染**: 只渲染必要的内容
5. **分离关注点**: 保持组件职责单一
